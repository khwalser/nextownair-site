<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Select Stops</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      margin: 16px;
      background: #020617;
      color: #e5e7eb;
    }
    h2 {
      margin-top: 0;
      margin-bottom: 0.25rem;
    }
    p {
      margin-top: 0.25rem;
      margin-bottom: 0.75rem;
      color: #9ca3af;
      font-size: 0.95rem;
    }
    #map {
      width: 100%;
      height: 320px;
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid #1f2937;
      margin-bottom: 0.75rem;
    }
    .layout {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    @media (min-width: 900px) {
      .layout {
        flex-direction: row;
      }
      #map {
        height: 420px;
      }
    }
    .sidebar {
      flex: 1;
      background: #020617;
      border-radius: 8px;
      border: 1px solid #1f2937;
      padding: 0.75rem 0.9rem;
      max-width: 360px;
    }
    .sidebar h3 {
      margin-top: 0;
      margin-bottom: 0.35rem;
      font-size: 1rem;
    }
    .sidebar small {
      color: #6b7280;
      display: block;
      margin-bottom: 0.5rem;
      font-size: 0.8rem;
    }
    .stop-item {
      padding: 6px 0;
      border-bottom: 1px solid #111827;
      font-size: 0.9rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .stop-item:last-child {
      border-bottom: none;
    }
    .stop-code {
      font-weight: 600;
      margin-right: 0.25rem;
    }
    .stop-meta {
      color: #9ca3af;
      font-size: 0.8rem;
    }
    .pill {
      display: inline-block;
      font-size: 0.7rem;
      padding: 1px 6px;
      border-radius: 999px;
      border: 1px solid #4b5563;
      color: #9ca3af;
    }
    .selected-pill {
      border-color: #22c55e;
      color: #bbf7d0;
    }
    .button-row {
      margin-top: 0.75rem;
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      align-items: center;
    }
    .button-primary {
      padding: 8px 16px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      background: #38bdf8;
      color: #020617;
      font-size: 0.9rem;
      font-weight: 500;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .button-primary:hover {
      filter: brightness(1.05);
    }
    .link-small {
      font-size: 0.8rem;
      color: #9ca3af;
      text-decoration: none;
    }
    .link-small:hover {
      color: #e5e7eb;
      text-decoration: underline;
    }
    .status {
      font-size: 0.8rem;
      color: #9ca3af;
      margin-top: 0.25rem;
    }
  </style>
</head>
<body>

<h2>Choose Your Stops</h2>
<p>
  Click EAS and regional airports on the map to add them as stops. This is a prototype
  – we’ll later use your choices to generate a fully dynamic itinerary.
</p>

<div class="layout">
  <div id="map"></div>

  <div class="sidebar">
    <h3>Selected Stops</h3>
    <small>Click markers to add or remove stops. Order is preserved.</small>
    <div id="selected-stops"></div>
    <div class="button-row">
      <button id="generate-btn" class="button-primary">
        Generate Itinerary →
      </button>
      <a href="preferences.html" class="link-small">← Back to preferences</a>
    </div>
    <div id="stops-status" class="status"></div>
  </div>
</div>

<!-- Leaflet JS -->
<script
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
  crossorigin=""
></script>
<script>
  // Simple helper: today's date in YYYY-MM-DD
  function todayISO() {
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth() + 1).padStart(2, "0");
    const dd = String(d.getDate()).padStart(2, "0");
    return `${yyyy}-${mm}-${dd}`;
  }

  // Prototype airport data (we'll replace with airports.json later)
  const AIRPORTS = [
    {
      code: "DTW",
      name: "Detroit Metro (DTW)",
      lat: 42.2162,
      lon: -83.3554,
      tags: ["hub", "origin"],
      note: "Major hub, starting point"
    },
    {
      code: "ESC",
      name: "Escanaba (ESC)",
      lat: 45.7228,
      lon: -87.0937,
      tags: ["EAS", "lakes"],
      note: "Upper Michigan lakes & lighthouses"
    },
    {
      code: "CMX",
      name: "Hancock / Houghton (CMX)",
      lat: 47.1684,
      lon: -88.4897,
      tags: ["EAS", "scenic"],
      note: "Keweenaw Peninsula & mining history"
    },
    {
      code: "BRD",
      name: "Brainerd (BRD)",
      lat: 46.4006,
      lon: -94.1280,
      tags: ["EAS", "lakes"],
      note: "Minnesota lakes & cabin country"
    },
    {
      code: "MSP",
      name: "Minneapolis (MSP)",
      lat: 44.8848,
      lon: -93.2223,
      tags: ["hub", "connector"],
      note: "Connector hub for the Upper Midwest"
    }
  ];

  const selectedCodes = [];
  const markerByCode = {};

  const map = L.map("map").setView([46.0, -89.0], 5);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 12,
    attribution: "© OpenStreetMap contributors"
  }).addTo(map);

  function renderSelectedStops() {
    const container = document.getElementById("selected-stops");
    const statusEl = document.getElementById("stops-status");
    container.innerHTML = "";

    if (!selectedCodes.length) {
      container.innerHTML =
        '<div class="stop-item"><span class="stop-meta">No stops selected yet.</span></div>';
      statusEl.textContent = "Tip: Start by selecting Escanaba and Houghton/Hancock.";
      return;
    }

    selectedCodes.forEach((code, index) => {
      const airport = AIRPORTS.find((a) => a.code === code);
      if (!airport) return;

      const div = document.createElement("div");
      div.className = "stop-item";

      const left = document.createElement("div");
      const codeSpan = document.createElement("span");
      codeSpan.className = "stop-code";
      codeSpan.textContent = `${index + 1}. ${airport.code}`;
      left.appendChild(codeSpan);

      const nameSpan = document.createElement("span");
      nameSpan.textContent = airport.name.replace(`(${airport.code})`, "").trim();
      left.appendChild(nameSpan);

      const meta = document.createElement("div");
      meta.className = "stop-meta";
      meta.textContent = airport.note;
      left.appendChild(meta);

      const right = document.createElement("span");
      right.className = "pill selected-pill";
      right.textContent = "Selected";

      div.appendChild(left);
      div.appendChild(right);
      container.appendChild(div);
    });

    statusEl.textContent = `${selectedCodes.length} stop${
      selectedCodes.length > 1 ? "s" : ""
    } selected.`;
  }

  function toggleStop(code) {
    const idx = selectedCodes.indexOf(code);
    if (idx === -1) {
      selectedCodes.push(code);
    } else {
      selectedCodes.splice(idx, 1);
    }
    renderSelectedStops();
  }

  // Add markers for each airport
  AIRPORTS.forEach((airport) => {
    const marker = L.marker([airport.lat, airport.lon]).addTo(map);
    markerByCode[airport.code] = marker;

    marker.bindPopup(
      `<strong>${airport.name}</strong><br/><small>${airport.note}</small><br/><em>Click marker to toggle as a stop.</em>`
    );

    marker.on("click", () => {
      toggleStop(airport.code);
    });
  });

  // Initial selected stops for the demo
  selectedCodes.push("ESC", "CMX", "BRD");
  renderSelectedStops();

  // When user clicks "Generate Itinerary", send selected stops + a start date
  document.getElementById("generate-btn").addEventListener("click", () => {
    const baseDate = todayISO();
    const params = new URLSearchParams();
    params.set("startDate", baseDate);
    if (selectedCodes.length) {
      params.set("stops", selectedCodes.join(","));
    }
    const url = `itinerary.html?${params.toString()}`;
    window.location.href = url;
  });
</script>
</body>
</html>
